{% extends "base.html" %}

{% block title %}FamilyCare - Controles Avançados{% endblock %}

{% block content %}

  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-background">
      <div class="hero-particles"></div>
    </div>
    <div class="container">
      <div class="row align-items-center min-vh-100">
        <div class="col-lg-8 mx-auto">
          <div class="hero-content">
            <h1 class="hero-title">
              <span class="highlight">Controles</span> Avançados
            </h1>
            <p class="hero-subtitle">
              Gerenciamento completo do banco de dados com ferramentas avançadas
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Database Stats Section -->
  <section class="stats-section">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 mx-auto text-center">
          <h2 class="section-title">Estatísticas Detalhadas</h2>
          <p class="section-subtitle">
            Contagem de registros em todas as tabelas
          </p>
        </div>
      </div>
      <div class="row g-4 mt-4">
        {% for table, count in stats.items() %}
        <div class="col-lg-3 col-md-6">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-table"></i>
            </div>
            <div class="stat-number">{{ count }}</div>
            <div class="stat-label">{{ table.replace('_', ' ').title() }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Table Management Section -->
  <section class="table-management-section">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 mx-auto text-center">
          <h2 class="section-title">Gerenciamento de Tabelas</h2>
          <p class="section-subtitle">
            Limpeza individual de tabelas com condições WHERE opcionais
          </p>
        </div>
      </div>
      <div class="row g-4 mt-4">
        {% for table, count in stats.items() %}
        <div class="col-lg-4 col-md-6">
          <div class="table-card">
            <div class="table-header">
              <div class="table-icon">
                <i class="fas fa-table"></i>
              </div>
              <div class="table-info">
                <h4>{{ table.replace('_', ' ').title() }}</h4>
                <span class="table-count">{{ count }} registros</span>
              </div>
            </div>
            <div class="table-actions btn-group-mobile">
              <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal('{{ table }}')">
                <i class="fas fa-trash"></i> Limpar
              </button>
              <button class="btn btn-sm btn-outline-warning" onclick="openWhereModal('{{ table }}')">
                <i class="fas fa-filter"></i> WHERE
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Database Control Section -->
  <section class="database-control-section">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 mx-auto text-center">
          <h2 class="section-title">Controle do Banco</h2>
          <p class="section-subtitle">
            Operações de alto nível no banco de dados
          </p>
        </div>
      </div>
      <div class="row g-4 mt-4">
        <div class="col-lg-3 col-md-6">
          <div class="control-card">
            <div class="control-icon">
              <i class="fas fa-database"></i>
            </div>
            <h3>Criar Banco</h3>
            <p>Cria o banco de dados familycare</p>
            <button class="btn btn-success" onclick="executeDatabaseAction('criar_banco')">
              <i class="fas fa-plus"></i> Criar
            </button>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="control-card">
            <div class="control-icon">
              <i class="fas fa-sync"></i>
            </div>
            <h3>Recriar Banco</h3>
            <p>Remove e recria o banco com dados fake</p>
            <button class="btn btn-warning" onclick="executeDatabaseAction('recriar_banco')">
              <i class="fas fa-sync"></i> Recriar
            </button>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="control-card">
            <div class="control-icon">
              <i class="fas fa-trash-alt"></i>
            </div>
            <h3>Remover Banco</h3>
            <p>Remove completamente o banco de dados</p>
            <button class="btn btn-danger" onclick="executeDatabaseAction('dropar_banco')">
              <i class="fas fa-trash"></i> Remover
            </button>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="control-card">
            <div class="control-icon">
              <i class="fas fa-eye"></i>
            </div>
            <h3>Visualizar Dados</h3>
            <p>Execute queries SELECT para visualizar dados</p>
            <button class="btn btn-info" onclick="openSQLModal()">
              <i class="fas fa-eye"></i> Visualizar
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modals -->
  
  <!-- Delete Table Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Exclusão</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja limpar a tabela <strong id="deleteTableName"></strong>?</p>
          <p class="text-danger">Esta ação não pode ser desfeita!</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" onclick="confirmDelete()">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- WHERE Condition Modal -->
  <div class="modal fade" id="whereModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Condição WHERE</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Digite a condição WHERE para filtrar os registros a serem excluídos:</p>
          <div class="mb-3">
            <label for="whereCondition" class="form-label">Condição WHERE (opcional)</label>
            <input type="text" class="form-control" id="whereCondition" placeholder="Ex: id > 100 AND status = 'ativo'">
            <div class="form-text">Deixe em branco para excluir todos os registros</div>
          </div>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Atenção:</strong> Apenas condições WHERE são permitidas. Não use comandos DROP, DELETE, UPDATE, INSERT, ALTER ou CREATE.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" onclick="confirmWhereDelete()">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SQL Modal -->
  <div class="modal fade" id="sqlModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Visualizar Dados</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="sqlQuery" class="form-label">Query SQL</label>
            <textarea class="form-control" id="sqlQuery" rows="5" placeholder="SELECT * FROM usuarios LIMIT 10"></textarea>
            <div class="form-text">Apenas queries SELECT são permitidas</div>
          </div>
          
          <!-- Exemplos de Queries -->
          <div class="mb-3">
            <label class="form-label">Exemplos Rápidos:</label>
            <div class="row g-2">
              <div class="col-md-6">
                <button class="btn btn-outline-primary btn-sm w-100" onclick="setSQLExample('SELECT * FROM usuarios LIMIT 10')">
                  <i class="fas fa-users"></i> Ver Usuários
                </button>
              </div>
              <div class="col-md-6">
                <button class="btn btn-outline-primary btn-sm w-100" onclick="setSQLExample('SELECT * FROM idosos LIMIT 10')">
                  <i class="fas fa-user-friends"></i> Ver Idosos
                </button>
              </div>
              <div class="col-md-6">
                <button class="btn btn-outline-primary btn-sm w-100" onclick="setSQLExample('SELECT * FROM alertas ORDER BY dataAlerta DESC LIMIT 10')">
                  <i class="fas fa-bell"></i> Ver Alertas
                </button>
              </div>
              <div class="col-md-6">
                <button class="btn btn-outline-primary btn-sm w-100" onclick="setSQLExample('SELECT * FROM recados ORDER BY data_hora DESC LIMIT 10')">
                  <i class="fas fa-comments"></i> Ver Recados
                </button>
              </div>
              <div class="col-md-6">
                <button class="btn btn-outline-primary btn-sm w-100" onclick="setSQLExample('SELECT * FROM familias')">
                  <i class="fas fa-home"></i> Ver Famílias
                </button>
              </div>
              <div class="col-md-6">
                <button class="btn btn-outline-primary btn-sm w-100" onclick="setSQLExample('SELECT * FROM remedios LIMIT 10')">
                  <i class="fas fa-pills"></i> Ver Remédios
                </button>
              </div>
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Dica:</strong> Use os botões acima para consultas rápidas ou digite sua própria query SELECT.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="executeSQL()">
            <i class="fas fa-eye"></i> Visualizar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Resultados</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="resultsContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block extra_scripts %}
<script>
let currentTable = '';
let currentAction = '';

function openDeleteModal(table) {
  currentTable = table;
  currentAction = 'delete';
  document.getElementById('deleteTableName').textContent = table.replace('_', ' ').toUpperCase();
  new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function openWhereModal(table) {
  currentTable = table;
  currentAction = 'where';
  document.getElementById('whereCondition').value = '';
  new bootstrap.Modal(document.getElementById('whereModal')).show();
}

function openSQLModal() {
  document.getElementById('sqlQuery').value = '';
  new bootstrap.Modal(document.getElementById('sqlModal')).show();
}

function setSQLExample(query) {
  document.getElementById('sqlQuery').value = query;
}

function confirmDelete() {
  executeTableAction(currentTable, '');
}

function confirmWhereDelete() {
  const whereCondition = document.getElementById('whereCondition').value;
  executeTableAction(currentTable, whereCondition);
}

function executeTableAction(table, whereCondition) {
  fetch('/limpar_tabela', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      table: table,
      where: whereCondition
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert('success', data.message);
      setTimeout(() => location.reload(), 1500);
    } else {
      showAlert('danger', data.message);
    }
  })
  .catch(error => {
    showAlert('danger', 'Erro na requisição: ' + error);
  });
}

function executeDatabaseAction(action) {
  const confirmMessage = {
    'criar_banco': 'Tem certeza que deseja criar o banco de dados?',
    'recriar_banco': 'Tem certeza que deseja recriar o banco? Isso irá apagar todos os dados!',
    'dropar_banco': 'Tem certeza que deseja remover o banco? Esta ação é irreversível!'
  };

  if (!confirm(confirmMessage[action])) return;

  fetch(`/${action}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert('success', data.message);
      if (action === 'recriar_banco') {
        setTimeout(() => location.reload(), 2000);
      }
    } else {
      showAlert('danger', data.message);
    }
  })
  .catch(error => {
    showAlert('danger', 'Erro na requisição: ' + error);
  });
}

function executeSQL() {
  const sql = document.getElementById('sqlQuery').value;
  
  if (!sql.trim()) {
    showAlert('warning', 'Digite uma query SQL');
    return;
  }

  fetch('/executar_sql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      sql: sql
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showResults(data.data, data.count);
    } else {
      showAlert('danger', data.message);
    }
  })
  .catch(error => {
    showAlert('danger', 'Erro na requisição: ' + error);
  });
}

function showResults(data, count) {
  let html = `
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0">
        <i class="fas fa-table text-primary"></i> 
        Resultados (${count} registros)
      </h6>
      <button class="btn btn-sm btn-outline-primary" onclick="exportToCSV()">
        <i class="fas fa-download"></i> Exportar CSV
      </button>
    </div>
  `;
  
  if (data.length > 0) {
    html += '<div class="table-responsive"><table class="table table-striped table-hover">';
    
    // Headers
    html += '<thead class="table-dark"><tr>';
    Object.keys(data[0]).forEach(key => {
      html += `<th>${key.replace('_', ' ').toUpperCase()}</th>`;
    });
    html += '</tr></thead>';
    
    // Data
    html += '<tbody>';
    data.forEach(row => {
      html += '<tr>';
      Object.values(row).forEach(value => {
        const formattedValue = formatCellValue(value);
        html += `<td>${formattedValue}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table></div>';
    
    // Store data for export
    window.currentResults = data;
  } else {
    html += `
      <div class="text-center py-4">
        <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-2">Nenhum resultado encontrado.</p>
      </div>
    `;
  }
  
  document.getElementById('resultsContent').innerHTML = html;
  new bootstrap.Modal(document.getElementById('resultsModal')).show();
}

function formatCellValue(value) {
  if (value === null || value === undefined) {
    return '<span class="text-muted">-</span>';
  }
  
  if (typeof value === 'boolean') {
    return value ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>';
  }
  
  if (typeof value === 'string' && value.length > 50) {
    return `<span title="${value}">${value.substring(0, 50)}...</span>`;
  }
  
  return value;
}

function exportToCSV() {
  if (!window.currentResults || window.currentResults.length === 0) {
    showAlert('warning', 'Nenhum dado para exportar');
    return;
  }
  
  const data = window.currentResults;
  const headers = Object.keys(data[0]);
  const csvContent = [
    headers.join(','),
    ...data.map(row => 
      headers.map(header => {
        const value = row[header];
        return typeof value === 'string' && value.includes(',') 
          ? `"${value}"` 
          : value;
      }).join(',')
    )
  ].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `dados_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showAlert('success', 'Dados exportados com sucesso!');
}

function showAlert(type, message) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  const container = document.querySelector('.flash-messages') || document.querySelector('main');
  container.insertBefore(alertDiv, container.firstChild);
  
  setTimeout(() => {
    alertDiv.remove();
  }, 5000);
}
</script>
{% endblock %}
